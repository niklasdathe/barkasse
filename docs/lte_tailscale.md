# Barkasse Hub – LTE (Quectel EC25) + NetworkManager + Tailscale (MagicDNS) Setup

This document describes the working configuration for the Barkasse hub (reTerminal DM) to provide:

- Reliable **LTE uplink** via **Quectel EC25** in **ECM mode** (Linux interface `usb0`)
- Network management via **NetworkManager**
- Remote access and private networking via **Tailscale**
- Stable DNS behavior (internet DNS stays working even if Tailscale is down), while still supporting **MagicDNS** for `*.tail158609.ts.net`

It also includes the key troubleshooting learnings we hit along the way (SIM PIN/PUK, APN issues, DNS hijack, NM vs ModemManager).

---

## 1. System context

### Hardware
- **reTerminal DM** (Linux SBC)
- **Quectel EC25** cellular modem (Telekom Germany SIM)

### OS / stack
- Debian-based Raspberry Pi OS
- Tools used:
  - **minicom** (AT-command terminal over `/dev/ttyUSB2`)
  - **NetworkManager** (`nmcli`) for interface and routing
  - **systemd-resolved** (`resolvectl`) for DNS
  - **Tailscale** (`tailscale`, `tailscale netcheck`) for remote access and MagicDNS

---

## 2. Key concept: ECM mode = `usb0`, not `wwan0`

We configured the EC25 to **ECM mode** using:

- `AT+QCFG="usbnet",1`  → ECM

In ECM mode, the modem presents itself as a **USB Ethernet NIC** and Linux typically names it **`usb0`** (or `enx...`).  
The seeed studio docs mention `wwan0`, but that usually applies to **QMI/MBIM** mode (different `usbnet` setting).

---

## 3. Modem configuration via minicom

### 3.1 Install and open minicom
```bash
sudo apt install minicom
sudo minicom -D /dev/ttyUSB2 -b 115200
```

### 3.2 Basic sanity
Inside minicom:
```text
AT
OK
```

Disable echo (optional, but helps readability):
```text
ATE0
```

### 3.3 SIM PIN / PUK handling (important lesson)
We initially hit:
- `+CPIN: SIM PIN` then `+CME ERROR: 16` (wrong PIN)
- eventually `+CPIN: SIM PUK` (SIM got PUK-locked)

**Takeaway:** Correct PIN formatting without "" is important as PINs—PUK lock is easy to trigger. Easiest way to enter PUK is with a smartphone

To check SIM state:
```text
AT+CPIN?
```

If SIM requires PIN:
```text
AT+CPIN=1234
```

To disable SIM PIN requirement (so reboots are headless):
```text
AT+CLCK="SC",0,"1234"
AT+CLCK="SC",2
```
Expected:
- `+CLCK: 0`  → SIM lock disabled ✅

### 3.4 Ensure ECM mode
```text
AT+QCFG="usbnet"
AT+QCFG="usbnet",1
AT+CFUN=1,1
```
`AT+CFUN=1,1` reboots the modem.

### 3.5 Telekom APN configuration (critical)
A major issue was that the modem showed an active context on **`ims`**, which is not normal internet.

We set Telekom internet APN:
```text
AT+CGDCONT=1,"IPV4V6","internet.v6.telekom"
AT+CFUN=1,1
```

Verify registration and data context:
```text
AT+QCSQ
AT+CEREG?
AT+CGATT?
AT+CGCONTRDP
```
Expected good signs:
- `+CEREG: 0,1`  (registered)
- `+CGATT: 1`    (attached)
- `+CGCONTRDP: ... internet.v6.telekom ...` ✅

**Note:** With `internet.v6.telekom`, the uplink is primarily **IPv6**. IPv4 may be missing/limited; that’s OK for Tailscale + SSH.

---

## 4. NetworkManager configuration (stable LTE on `usb0`)

### 4.1 Remove duplicate profiles (if any)
```bash
nmcli -t -f NAME,UUID con show | grep '^lte-usb0:' || true
sudo nmcli con delete uuid <UUID>
```

### 4.2 Disable ModemManager (recommended for ECM)
In ECM mode, we treat the modem like Ethernet; ModemManager can interfere and cause device churn.

```bash
sudo systemctl disable --now ModemManager
sudo systemctl restart NetworkManager
```

Verify NM sees `usb0`:
```bash
nmcli dev status
```

### 4.3 Create the LTE connection profile
```bash
sudo nmcli con add type ethernet ifname usb0 con-name lte-usb0 ipv4.method auto ipv6.method auto
sudo nmcli con modify lte-usb0 connection.autoconnect yes ipv4.route-metric 100 ipv6.route-metric 100
sudo nmcli con up lte-usb0
```

Verify addressing and DNS learned from LTE:
```bash
nmcli -p dev show usb0 | egrep 'GENERAL.STATE|GENERAL.CONNECTION|IP4.ADDRESS|IP4.GATEWAY|IP6.ADDRESS|IP6.GATEWAY|DNS'
ip route
ip -6 route | head
```

### 4.4 Quick uplink test (force `usb0`)
```bash
curl --interface usb0 https://example.com -v --connect-timeout 15
ping -6 -I usb0 2606:4700:4700::1111 -c 3
```

If IPv4 ping fails (`ping -I usb0 1.1.1.1`), that can be normal for `internet.v6.telekom`.

---

## 5. DNS: fix “no internet” due to Tailscale overwriting resolv.conf

### 5.1 Symptom
We had working IPv6 connectivity (ping to IPv6 literal worked), but:
- `curl https://example.com` failed: “Could not resolve host”
- `resolvectl` failed: `dbus-org.freedesktop.resolve1.service not found`

And `/etc/resolv.conf` contained:
```text
# resolv.conf(5) file generated by tailscale
nameserver 100.100.100.100
```
This caused DNS to break when the local DNS stack wasn’t set up to integrate with Tailscale properly.

### 5.2 Correct fix: use systemd-resolved + let NetworkManager feed it
1) Prevent Tailscale from taking over DNS (we’ll do split DNS later):
```bash
sudo tailscale set --accept-dns=false
```

2) Enable systemd-resolved:
```bash
sudo systemctl enable --now systemd-resolved
```

3) Make `/etc/resolv.conf` point to the systemd-resolved stub:
```bash
sudo rm -f /etc/resolv.conf
sudo ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf
```

4) Tell NetworkManager to use systemd-resolved:
```bash
sudo mkdir -p /etc/NetworkManager/conf.d
printf "[main]\ndns=systemd-resolved\n" | sudo tee /etc/NetworkManager/conf.d/10-dns-systemd-resolved.conf >/dev/null
sudo systemctl restart NetworkManager
```

Verify DNS works:
```bash
resolvectl status | head -n 80
resolvectl query deb.debian.org
curl --interface usb0 https://example.com -v --connect-timeout 15
sudo apt update
```

---

## 6. Tailscale + MagicDNS without breaking “normal” internet DNS

Goal:
- Internet DNS continues to work even if Tailscale is down
- MagicDNS names (`*.tail158609.ts.net`) resolve via Tailscale

### 6.1 Ensure Tailscale DNS server is reachable via tailscale0
```bash
ip route get 100.100.100.100
```
Expected:
- `dev tailscale0` ✅

### 6.2 Use **split DNS** in systemd-resolved
Keep Tailscale from overwriting system DNS:
```bash
sudo tailscale set --accept-dns=false
```

Configure split DNS:
```bash
sudo resolvectl dns tailscale0 100.100.100.100
sudo resolvectl domain tailscale0 '~tail158609.ts.net'
sudo resolvectl flush-caches
```

Verify:
```bash
tailscale status
resolvectl query desktopcaspar.tail158609.ts.net
```

### 6.3 Make split DNS persistent across reboot
Create helper script:
```bash
sudo tee /usr/local/sbin/tailscale-splitdns.sh >/dev/null <<'EOF'
#!/bin/sh
set -e
resolvectl dns tailscale0 100.100.100.100
resolvectl domain tailscale0 '~tail158609.ts.net'
resolvectl flush-caches
EOF
sudo chmod +x /usr/local/sbin/tailscale-splitdns.sh
```

Create a systemd service:
```bash
sudo tee /etc/systemd/system/tailscale-splitdns.service >/dev/null <<'EOF'
[Unit]
Description=Configure split DNS for Tailscale MagicDNS
After=systemd-resolved.service tailscaled.service network-online.target
Wants=systemd-resolved.service tailscaled.service network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/sbin/tailscale-splitdns.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable --now tailscale-splitdns.service
```

---

## 7. Final “known-good” state (snapshot)

### Modem (AT layer)
- SIM unlocked and **PIN disabled**
  - `AT+CPIN?` → `READY`
  - `AT+CLCK="SC",2` → `+CLCK: 0`
- Registered on LTE and attached
  - `AT+CEREG?` → `0,1`
  - `AT+CGATT?` → `1`
- APN:
  - `AT+CGCONTRDP` includes `internet.v6.telekom`
- ECM:
  - `AT+QCFG="usbnet"` → `1`

### Linux networking
- `usb0` is up with:
  - IPv4: `192.168.225.24/24` (gateway `192.168.225.1`)
  - IPv6: global `2a01:...`
  - IPv6 default route via `fe80::... dev usb0`
- NetworkManager profile:
  - `lte-usb0` bound to `usb0`, autoconnect enabled, metric 100
- ModemManager disabled:
  - `systemctl is-enabled ModemManager` → disabled

### DNS
- systemd-resolved enabled, `/etc/resolv.conf` points to stub
- NetworkManager configured with `dns=systemd-resolved`
- Split DNS:
  - `~tail158609.ts.net` → `100.100.100.100` on `tailscale0`
  - All other DNS stays on LTE-provided resolvers

### Tailscale
- `--accept-dns=false`
- MagicDNS works via split DNS
- `tailscale netcheck` shows IPv6 available; IPv4 may be absent (OK)

---

## 8. Troubleshooting quick reference

### “usb0 has IP but no internet”
- Check LTE registration/attach:
  - `AT+CEREG?`, `AT+CGATT?`, `AT+CGCONTRDP`
- Check APN not `ims` (must be `internet.v6.telekom` or desired APN)
- Test without DNS:
  - `ping -6 -I usb0 2606:4700:4700::1111`

### “Internet works by IP but not by hostname”
- Check `/etc/resolv.conf` is not forced to `100.100.100.100` only
- Ensure systemd-resolved is running:
  - `systemctl status systemd-resolved`
- Ensure NM uses systemd-resolved:
  - `/etc/NetworkManager/conf.d/10-dns-systemd-resolved.conf`

### “MagicDNS doesn’t resolve, but internet DNS is OK”
- Ensure split DNS is set:
  - `resolvectl status` should show `tailscale0` DNS and domain `~tail158609.ts.net`
- Make sure route to `100.100.100.100` goes via `tailscale0`:
  - `ip route get 100.100.100.100`

---

## 9. Suggested handover notes (project hygiene)

- Keep this setup scripted (AT commands + NM profile + systemd units).
- Document where the SIM PUK is stored and how to unlock SIM safely.
- Consider a hardware note: LTE antenna must be correctly connected to the EC25 MAIN port and routed outside metal cabinets.
- For long-term reliability:
  - Prefer LTE `usb0` route metrics lower than Wi-Fi if LTE should be primary.
  - Monitor connectivity with a periodic health check (e.g., `tailscale netcheck`, `curl --interface usb0 https://example.com`).

---

## Appendix: Useful commands

### NetworkManager
```bash
nmcli dev status
nmcli con show --active
nmcli -p dev show usb0
sudo nmcli con up lte-usb0
```

### DNS
```bash
resolvectl status
resolvectl query deb.debian.org
ls -l /etc/resolv.conf
```

### Tailscale
```bash
tailscale status
tailscale netcheck
ip route get 100.100.100.100
```

### Modem AT checks (minicom)
```text
AT+QCSQ
AT+CEREG?
AT+CGATT?
AT+CGCONTRDP
AT+QCFG="usbnet"
```
